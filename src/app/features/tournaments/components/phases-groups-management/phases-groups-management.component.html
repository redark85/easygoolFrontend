<div class="phases-groups-container">
  <mat-card class="phases-management-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>timeline</mat-icon>
        Fases del Torneo
      </mat-card-title>
      <mat-card-subtitle>
        Administra las fases y grupos de tu torneo
      </mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <!-- Floating Action Button for Phases -->
      <button mat-fab
              class="fab-fixed add-phase-btn"
              (click)="createPhase()"
              matTooltip="Crear nueva fase">
        <mat-icon>add</mat-icon>
      </button>

      <!-- No Phases Message -->
      <div class="no-phases" *ngIf="phases.length === 0">
        <mat-icon class="no-phases-icon">timeline</mat-icon>
        <h3>No hay fases configuradas</h3>
        <p>Comienza creando la primera fase de tu torneo</p>
      </div>

      <!-- Phases Cards -->
      <div *ngIf="phases.length > 0" class="phases-cards">
        <mat-card *ngFor="let phase of phases; trackBy: trackByPhaseId" class="phase-card">
          <!-- Phase Header -->
          <mat-card-header class="phase-card-header">
            <div class="phase-header-content">
              <div class="phase-info">
                <mat-icon class="phase-icon">{{ getPhaseTypeIcon(phase.phaseType) }}</mat-icon>
                <div class="phase-details">
                  <h3 class="phase-name">{{ phase.name }}</h3>
                  <mat-chip class="phase-type-chip"
                           [class]="'phase-type-' + phase.phaseType">
                    {{ getPhaseTypeText(phase.phaseType) }}
                  </mat-chip>
                </div>
              </div>

              <div class="phase-stats">
                <mat-icon class="groups-count-icon"
                          matBadge="{{ phase.groups?.length || 0 }}"
                          matBadgeColor="accent"
                          matBadgeSize="small"
                          matTooltip="{{ (phase.groups?.length || 0) === 1 ? '1 grupo' : (phase.groups?.length || 0) + ' grupos' }}">
                  group_work
                </mat-icon>

                <!-- Phase Action Buttons -->
                <div class="phase-actions-inline">
                  <button mat-icon-button
                          color="primary"
                          (click)="createGroup(phase)"
                          matTooltip="Agregar Grupo"
                          class="phase-action-btn">
                    <mat-icon>add</mat-icon>
                  </button>
                  <button mat-icon-button
                          (click)="editPhase(phase)"
                          matTooltip="Editar Fase"
                          class="phase-action-btn">
                    <mat-icon>edit</mat-icon>
                  </button>
                  <button mat-icon-button
                          color="warn"
                          (click)="deletePhase(phase)"
                          matTooltip="Eliminar Fase"
                          class="phase-action-btn">
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              </div>
            </div>
          </mat-card-header>

          <!-- Phase Content -->
          <mat-card-content class="phase-card-content">
            <!-- No Groups Message -->
            <div class="no-groups" *ngIf="!phase.groups || phase.groups.length === 0">
              <mat-icon class="no-groups-icon">group_work</mat-icon>
              <p>No hay grupos en esta fase</p>
            </div>

            <!-- Groups Grid - 3 columns with expansion panels -->
            <div *ngIf="phase.groups && phase.groups.length > 0" class="groups-grid">
              <mat-expansion-panel *ngFor="let group of phase.groups; trackBy: trackByGroupId; let i = index"
                                   class="group-panel"
                                   [expanded]="expandedGroupIndex === i"
                                   (opened)="expandedGroupIndex = i"
                                   (closed)="expandedGroupIndex = -1">
                <mat-expansion-panel-header class="group-header">
                  <mat-panel-title>
                    <div class="group-title-content">
                      <mat-icon class="group-icon">group_work</mat-icon>
                      <span class="group-name" [matTooltip]="group.name">{{ group.name }}</span>
                    </div>
                  </mat-panel-title>
                  <mat-panel-description>
                    <div class="group-stats">
                      <mat-chip class="teams-count-chip"
                               [matTooltip]="(group.teams?.length || 0) === 1 ? '1 equipo' : (group.teams?.length || 0) + ' equipos'">
                        <mat-icon>groups</mat-icon>
                        {{ group.teams?.length || 0 }}
                      </mat-chip>

                      <!-- Group Action Buttons -->
                      <div class="group-actions-inline">
                        <button mat-icon-button
                                color="primary"
                                (click)="addTeamToGroup(phase.id, group.id); $event.stopPropagation()"
                                matTooltip="Agregar Equipo"
                                class="group-action-btn">
                          <mat-icon>add</mat-icon>
                        </button>
                        <button mat-icon-button
                                (click)="editGroup(group); $event.stopPropagation()"
                                matTooltip="Editar Grupo"
                                class="group-action-btn">
                          <mat-icon>edit</mat-icon>
                        </button>
                        <button mat-icon-button
                                color="warn"
                                (click)="deleteGroup(group); $event.stopPropagation()"
                                matTooltip="Eliminar Grupo"
                                class="group-action-btn">
                          <mat-icon>delete</mat-icon>
                        </button>
                      </div>
                    </div>
                  </mat-panel-description>
                </mat-expansion-panel-header>

                <!-- Group Content - Teams -->
                <div class="group-content">
                  <!-- No Teams Message -->
                  <div class="no-teams-in-group" *ngIf="!group.teams || group.teams.length === 0">
                    <mat-icon class="no-teams-icon">groups</mat-icon>
                    <p>No hay equipos en este grupo</p>
                    <button mat-fab
                            color="primary"
                            (click)="addTeamToGroup(phase.id, group.id)"
                            matTooltip="Agregar Primer Equipo"
                            class="add-first-team-btn">
                      <mat-icon>add</mat-icon>
                    </button>
                  </div>

                  <!-- Teams List -->
                  <div class="teams-in-group" *ngIf="group.teams && group.teams.length > 0">
                    <div class="team-item"
                         *ngFor="let team of group.teams; trackBy: trackByTeamId">
                      <div class="team-avatar">
                        <img [src]="team.logoBase64 ? 'data:' + team.logoContentType + ';base64,' + team.logoBase64 : 'assets/logo.png'"
                             [alt]="team.name"
                             class="team-logo"
                             (error)="$event.target.src='assets/logo.png'">
                      </div>

                      <div class="team-info">
                        <h5 class="team-name">{{ team.name }}</h5>
                        <span class="team-short-name">{{ team.shortName }}</span>
                      </div>

                      <div class="team-actions">
                        <button mat-icon-button
                                color="accent"
                                (click)="disqualifyTeam(team, group)"
                                matTooltip="Descalificar equipo"
                                class="disqualify-team-btn">
                          <mat-icon>block</mat-icon>
                        </button>
                        <button mat-icon-button
                                color="warn"
                                (click)="removeTeamFromGroup(team, group)"
                                matTooltip="Quitar del grupo"
                                class="remove-team-btn">
                          <mat-icon>remove_circle</mat-icon>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </mat-expansion-panel>
            </div>
          </mat-card-content>
        </mat-card>
      </div>
    </mat-card-content>
  </mat-card>
</div>
