<div class="phases-groups-container">
  <mat-card class="phases-management-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>timeline</mat-icon>
        Fases del Torneo
      </mat-card-title>
      <mat-card-subtitle>
        Administra las fases y grupos de tu torneo
      </mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <!-- Floating Action Button for Phases -->
      <button mat-fab
              class="fab-fixed add-phase-btn"
              (click)="createPhase()"
              matTooltip="Crear nueva fase"
              [disabled]="isLoadingPhases">
        <mat-icon>add</mat-icon>
      </button>

      <!-- Loading State -->
      <div class="loading-container" *ngIf="isLoadingPhases">
        <mat-progress-spinner mode="indeterminate" diameter="50"></mat-progress-spinner>
        <p>Cargando fases del torneo...</p>
      </div>

      <!-- No Phases Message -->
      <div class="no-phases" *ngIf="!isLoadingPhases && phases.length === 0">
        <mat-icon class="no-phases-icon">timeline</mat-icon>
        <h3>No hay fases configuradas</h3>
        <p>Comienza creando la primera fase de tu torneo</p>
      </div>

      <!-- Phases Cards -->
      <div *ngIf="!isLoadingPhases && phases.length > 0" class="phases-cards">
        <mat-card *ngFor="let phase of phases; trackBy: trackByPhaseId" class="phase-card">
          <!-- Phase Header -->
          <mat-card-header class="phase-card-header">
            <div class="phase-header-content">
              <div class="phase-info">
                <mat-icon class="phase-icon">{{ getPhaseTypeIcon(phase.phaseType) }}</mat-icon>
                <div class="phase-details">
                  <h3 class="phase-name">{{ phase.name }}</h3>
                  <mat-chip class="phase-type-chip"
                           [class]="'phase-type-' + phase.phaseType">
                    {{ getPhaseTypeText(phase.phaseType) }}
                  </mat-chip>
                </div>
              </div>

              <div class="phase-stats">
                <!-- Show groups for GroupStage, teams for Knockout -->
                <mat-icon class="groups-count-icon"
                          matBadge="{{ phase.phaseType === 1 ? (phase.knockoutTeams?.length || 0) : (phase.groups?.length || 0) }}"
                          matBadgeColor="accent"
                          matBadgeSize="small"
                          [matTooltip]="phase.phaseType === 1 ? 
                            ((phase.knockoutTeams?.length || 0) === 1 ? '1 equipo' : (phase.knockoutTeams?.length || 0) + ' equipos') :
                            ((phase.groups?.length || 0) === 1 ? '1 grupo' : (phase.groups?.length || 0) + ' grupos')">
                  {{ phase.phaseType === 1 ? 'groups' : 'group_work' }}
                </mat-icon>

                <!-- Phase Action Buttons -->
                <div class="phase-actions-inline">
                  <button mat-icon-button
                          color="primary"
                          (click)="phase.phaseType === 0 ? createGroup(phase) : addTeamToPhase(phase.id, phase.name)"
                          [matTooltip]="phase.phaseType === 1 ? 'Agregar Equipo' : 'Agregar Grupo'"
                          class="phase-action-btn">
                    <mat-icon>add</mat-icon>
                  </button>
                  <!-- BotÃ³n para asignar equipos aleatoriamente - Solo para GroupStage -->
                  <button mat-icon-button
                          *ngIf="phase.phaseType === 0"
                          color="accent"
                          (click)="assignTeamsRandomly(phase)"
                          matTooltip="Asignar equipos aleatoriamente"
                          class="phase-action-btn">
                    <mat-icon>shuffle</mat-icon>
                  </button>
                  <button mat-icon-button
                          (click)="editPhase(phase)"
                          matTooltip="Editar Fase"
                          class="phase-action-btn">
                    <mat-icon>edit</mat-icon>
                  </button>
                  <button mat-icon-button
                          color="warn"
                          (click)="deletePhase(phase)"
                          matTooltip="Eliminar Fase"
                          class="phase-action-btn"
                          [disabled]="!canDeletePhase(phase)"
                          [matTooltip]="canDeletePhase(phase) ? 'Eliminar Fase' : 'No se puede eliminar: hay equipos asignados'">
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              </div>
            </div>
          </mat-card-header>

          <!-- Phase Content -->
          <mat-card-content class="phase-card-content">
            <!-- No Groups/Teams Message -->
            <div class="no-groups" *ngIf="phase.phaseType === 0 && (!phase.groups || phase.groups.length === 0)">
              <mat-icon class="no-groups-icon">group_work</mat-icon>
              <p>No hay grupos en esta fase</p>
            </div>

            <div class="no-groups" *ngIf="phase.phaseType === 1 && (!phase.knockoutTeams || phase.knockoutTeams.length === 0)">
              <mat-icon class="no-groups-icon">groups</mat-icon>
              <p>No hay equipos en esta fase</p>
            </div>

            <!-- Groups Grid - 3 columns with expansion panels (Only for GroupStage) -->
            <div *ngIf="phase.phaseType === 0 && phase.groups && phase.groups.length > 0" class="row row-cols-1 row-cols-md-2 row-cols-lg-3">
              <div *ngFor="let group of phase.groups; trackBy: trackByGroupId; let i = index" class="col mb-4">
                <mat-expansion-panel class="group-panel"
                                     [expanded]="expandedGroupIndex === i"
                                     (opened)="expandedGroupIndex = i">
                  <mat-expansion-panel-header class="group-header">
                    <mat-panel-title>
                      <div class="group-title-content">
                        <mat-icon class="group-icon">group_work</mat-icon>
                        <span class="group-name" [matTooltip]="group.name">{{ group.name }}</span>
                      </div>
                    </mat-panel-title>
                    <mat-panel-description>
                      <div class="group-stats">
                        <mat-chip class="teams-count-chip"
                                  [matTooltip]="(group.teams?.length || 0) === 1 ? '1 equipo' : (group.teams?.length || 0) + ' equipos'">
                          <mat-icon>groups</mat-icon>
                          {{ group.teams?.length || 0 }}
                        </mat-chip>

                        <div class="group-actions-inline">
                          <div class="action-button-wrapper">
                            <button mat-icon-button
                                    color="primary"
                                    (click)="addTeamToGroup(phase.id, group.id); $event.stopPropagation()"
                                    matTooltip="Agregar Equipo"
                                    class="group-action-btn">
                              <mat-icon>add</mat-icon>
                            </button>
                          </div>
                          <div class="action-button-wrapper">
                            <button mat-icon-button
                                    (click)="editGroup(group); $event.stopPropagation()"
                                    matTooltip="Editar Grupo"
                                    class="group-action-btn">
                              <mat-icon>edit</mat-icon>
                            </button>
                          </div>
                          <div class="action-button-wrapper">
                            <button mat-icon-button
                                    color="warn"
                                    (click)="deleteGroup(group); $event.stopPropagation()"
                                    class="group-action-btn"
                                    [disabled]="!canDeleteGroup(group)"
                                    [matTooltip]="canDeleteGroup(group) ? 'Eliminar Grupo' : 'No se puede eliminar: hay equipos en el grupo'">
                              <mat-icon>delete</mat-icon>
                            </button>
                          </div>
                        </div>
                      </div>
                    </mat-panel-description>
                  </mat-expansion-panel-header>

                  <div>
                    <div class="no-teams-in-group" *ngIf="!group.teams || group.teams.length === 0">
                      <mat-icon class="no-teams-icon">groups</mat-icon>
                      <p>No hay equipos en este grupo</p>
                    </div>

                    <div class="teams-in-group" *ngIf="group.teams && group.teams.length > 0">
                      <div class="team-item"
                           *ngFor="let team of group.teams; trackBy: trackByTeamId">
                        <div class="team-avatar">
                          <img [src]="team.logoUrl || 'assets/default-team.jpg'"
                               [alt]="team.name"
                               class="team-logo"
                               (error)="$event.target.src='assets/default-team.jpg'">
                          
                          <!-- Status Badge sobre la imagen -->
                          <div [class]="getTeamStatusClass(team.status)"
                               [matTooltip]="getTeamStatusText(team.status)"
                               matTooltipPosition="above">
                            <mat-icon class="status-icon">{{ getTeamStatusIcon(team.status) }}</mat-icon>
                          </div>
                        </div>

                        <div class="team-info">
                          <h5 class="team-name">{{ team.name }}</h5>
                          <span class="team-short-name">{{ team.shortName }}</span>
                        </div>

                        <div class="team-actions">
                          <button mat-icon-button
                                  (click)="disqualifyTeam(team, group)"
                                  [disabled]="!canDisqualifyTeam(team)"
                                  [matTooltip]="canDisqualifyTeam(team) ? 'Descalificar equipo' : 'Equipo ya descalificado'"
                                  [class]="canDisqualifyTeam(team) ? 'text-warning' : 'text-muted'"
                                  class="disqualify-team-btn">
                            <mat-icon>gavel</mat-icon>
                          </button>
                          <button mat-icon-button
                                  color="warn"
                                  (click)="removeTeamFromGroup(team, group)"
                                  matTooltip="Quitar del grupo"
                                  class="remove-team-btn">
                            <mat-icon>remove_circle</mat-icon>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </mat-expansion-panel>
              </div>
            </div>

            <!-- Teams Grid for Knockout phases -->
            <div *ngIf="phase.phaseType === 1 && phase.knockoutTeams && phase.knockoutTeams.length > 0" class="knockout-teams-grid">
              <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 row-cols-xl-4">
                <div *ngFor="let team of phase.knockoutTeams; trackBy: trackByTeamId" class="col mb-3">
                  <mat-card class="team-card">
                    <mat-card-content class="team-card-content">
                      <div class="team-info-knockout">
                        <div class="team-avatar-knockout">
                          <img [src]="team.logoUrl || 'assets/default-team.jpg'"
                               [alt]="team.name"
                               class="team-logo-knockout"
                               (error)="$event.target.src='assets/default-team.jpg'">
                          
                          <!-- Status Badge sobre la imagen -->
                          <div [class]="getTeamStatusClass(team.status)"
                               [matTooltip]="getTeamStatusText(team.status)"
                               matTooltipPosition="above">
                            <mat-icon class="status-icon">{{ getTeamStatusIcon(team.status) }}</mat-icon>
                          </div>
                        </div>
                        <div class="team-details-knockout">
                          <h5 class="team-name-knockout">{{ team.name }}</h5>
                          <span class="team-short-name-knockout">{{ team.shortName }}</span>
                        </div>
                      </div>
                      <div class="team-actions-knockout">
                        <button mat-icon-button
                                  (click)="disqualifyTeam(team)"
                                  [disabled]="!canDisqualifyTeam(team)"
                                  [matTooltip]="canDisqualifyTeam(team) ? 'Descalificar equipo' : 'Equipo ya descalificado'"
                                  [class]="canDisqualifyTeam(team) ? 'text-warning' : 'text-muted'"
                                  class="disqualify-team-btn">
                            <mat-icon>gavel</mat-icon>
                          </button>
                        <button mat-icon-button
                                color="warn"
                                (click)="removeTeamFromPhase(team, phase)"
                                matTooltip="Quitar de la fase"
                                class="remove-team-knockout-btn">
                          <mat-icon>remove_circle</mat-icon>
                        </button>
                      </div>
                    </mat-card-content>
                  </mat-card>
                </div>
              </div>
            </div>
          </mat-card-content>
        </mat-card>
      </div>
    </mat-card-content>
  </mat-card>
</div>
