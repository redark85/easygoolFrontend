<div class="teams-management-container">
  <mat-card class="teams-management-card">
    <mat-card-header>
      <div class="container-fluid">
        <!-- Layout Desktop - Título y buscador en la misma fila -->
        <div class="row align-items-center desktop-header-layout d-none d-md-flex">
          <div class="col-6">
            <mat-card-title>
              <mat-icon>groups</mat-icon>
              Equipos del Torneo
            </mat-card-title>
            <mat-card-subtitle class="subtitle-team-management">
              Administra los equipos participantes en tu torneo
            </mat-card-subtitle>
          </div>

          <div class="col-6">
            <div class="row justify-content-end">
              <div class="col-auto">
                <mat-form-field appearance="outline" class="search-field">
                  <mat-label>Buscar equipos</mat-label>
                  <input matInput
                         [(ngModel)]="searchTerm"
                         (input)="onSearchChange()"
                         placeholder="Nombre o nombre corto"
                         autocomplete="off">
                  <mat-icon matSuffix>search</mat-icon>
                </mat-form-field>
              </div>
            </div>
          </div>
        </div>

        <!-- Layout Móvil - Título arriba, buscador abajo -->
        <div class="mobile-header-layout d-block d-md-none">
          <!-- Título en la primera fila -->
          <div class="row">
            <div class="col-12">
              <mat-card-title>
                <mat-icon>groups</mat-icon>
                Equipos del Torneo
              </mat-card-title>
            </div>
          </div>
          
          <!-- Buscador en la segunda fila -->
          <div class="row mt-3">
            <div class="col-12">
              <mat-form-field appearance="outline" class="search-field w-100">
                <mat-label>Buscar equipos</mat-label>
                <input matInput
                       [(ngModel)]="searchTerm"
                       (input)="onSearchChange()"
                       placeholder="Nombre o nombre corto"
                       autocomplete="off">
                <mat-icon matSuffix>search</mat-icon>
              </mat-form-field>
            </div>
          </div>
        </div>
      </div>
    </mat-card-header>

    <mat-card-content>
      <!-- Floating Action Button for Teams -->
      <button mat-fab
              class="fab-fixed add-team-btn"
              (click)="createTeam()"
              matTooltip="Crear nuevo equipo">
        <mat-icon>add</mat-icon>
      </button>

      <!-- No Teams Message -->
      <div class="no-teams" *ngIf="filteredTeams.length === 0 && searchTerm === ''">
        <mat-icon class="no-teams-icon">groups</mat-icon>
        <h3>No hay equipos registrados</h3>
        <p>Comienza agregando el primer equipo a tu torneo</p>
      </div>

      <!-- No Search Results -->
      <div class="no-teams" *ngIf="filteredTeams.length === 0 && searchTerm !== ''">
        <mat-icon class="no-teams-icon">search_off</mat-icon>
        <h3>No se encontraron equipos</h3>
        <p>No hay equipos que coincidan con "{{ searchTerm }}"</p>
      </div>

      <!-- Teams List con Paneles de Expansión -->
      <div *ngIf="filteredTeams.length > 0" class="teams-list">
        <mat-accordion [multi]="false">
        <mat-expansion-panel *ngFor="let team of filteredTeams; trackBy: trackByTeamId" class="team-panel">
          <mat-expansion-panel-header>
            <mat-panel-title class="w-100">
              <!-- Layout para Web (Desktop) - Mantener intacto -->
              <div class="row align-items-center w-100 g-3 desktop-layout">
                <!-- Avatar e info principal -->
                <div class="col-md-4 d-flex align-items-center">
                  <div class="team-avatar me-3 position-relative">
                    <img [src]="team.logoUrl || 'assets/default-team.png'"
                         [alt]="team.name"
                         class="team-logo"
                         (error)="$event.target.src='assets/default-team.png'"
                         width="50" height="50">
                    <!-- Status Badge sobre la imagen -->
                    <div [class]="getTeamStatusClass(team.status)"
                         [matTooltip]="getTeamStatusText(team.status)"
                         matTooltipPosition="above">
                      <mat-icon class="status-icon">{{ getTeamStatusIcon(team.status) }}</mat-icon>
                    </div>
                  </div>
                  <div class="team-info">
                    <h5 class="mb-1 fw-bold">{{ team.name }}</h5>
                    <small class="text-muted">{{ team.shortName }}</small>
                  </div>
                </div>

                <!-- Estadísticas -->
                <div class="col-md-3 d-flex align-items-center">
                  <div class="d-flex align-items-center me-3">
                    <mat-icon class="text-primary me-1">people</mat-icon>
                    <span class="badge bg-primary rounded-pill">{{ team.totalPlayers }}</span>
                  </div>
                  <div class="manager-info flex-grow-1">
                    <div class="manager-name-container" *ngIf="team.manager; else noManager">
                      <small class="manager-link"
                             (click)="openManagerInfoModal(team); $event.stopPropagation()"
                             matTooltip="Click para ver información completa del manager"
                             matTooltipPosition="above">
                        Manager: {{ team.manager.managerName }}
                      </small>
                    </div>
                    <ng-template #noManager>
                      <small class="text-muted d-block no-manager-text">Sin manager asignado</small>
                    </ng-template>
                  </div>
                </div>

                <!-- Switch -->
                <div class="col-md-2 d-flex justify-content-left">
                  <mat-slide-toggle
                    [checked]="team.allowPlayerRegistration || false"
                    (change)="onTogglePlayerRegistration(team, $event)"
                    (click)="$event.stopPropagation()"
                    [disabled]="isUpdatingTeamRegistration(team)"
                    [matTooltip]="isUpdatingTeamRegistration(team) ? 'Actualizando...' : 'Permitir registro de jugadores'"
                    class="registration-toggle">
                    <span class="toggle-label">
                      <mat-spinner *ngIf="isUpdatingTeamRegistration(team)" diameter="16" class="inline-spinner"></mat-spinner>
                      {{ (team.allowPlayerRegistration || false) ? 'Habilitado' : 'Deshabilitado' }}
                    </span>
                  </mat-slide-toggle>
                </div>

                <!-- Acciones -->
                <div class="col-md-3 d-flex justify-content-end">
                  <div class="btn-group" role="group">
                    <button mat-icon-button
                            (click)="createPlayer(team); $event.stopPropagation()"
                            matTooltip="Agregar jugador"
                            class="text-success">
                      <mat-icon>person_add</mat-icon>
                    </button>
                    <button mat-icon-button
                            (click)="editTeam(team); $event.stopPropagation()"
                            matTooltip="Editar equipo"
                            class="text-primary">
                      <mat-icon>edit</mat-icon>
                    </button>
                    <button mat-icon-button
                            (click)="deleteTeam(team); $event.stopPropagation()"
                            matTooltip="Eliminar equipo"
                            class="text-danger">
                      <mat-icon>delete</mat-icon>
                    </button>
                    <button mat-icon-button
                            [matTooltip]="team.hasExcelUploaded ? 'Excel ya subido' : 'Subir excel de registro de jugadores'"
                            [class]="team.hasExcelUploaded ? 'text-muted' : 'text-info'"
                            [disabled]="team.hasExcelUploaded"
                            (click)="uploadExcelDocument(team); $event.stopPropagation()">
                      <mat-icon>upload_file</mat-icon>
                    </button>
                    <!-- Botón para descalificar (solo si está activo) -->
                    <button mat-icon-button
                            *ngIf="canDisqualifyTeam(team)"
                            (click)="disqualifyTeam(team); $event.stopPropagation()"
                            matTooltip="Descalificar equipo"
                            class="text-warning">
                      <mat-icon>gavel</mat-icon>
                    </button>

                    <!-- Botón para reactivar (solo si está descalificado) -->
                    <button mat-icon-button
                            *ngIf="canReactivateTeam(team)"
                            (click)="reactivateTeam(team); $event.stopPropagation()"
                            matTooltip="Volver a validar equipo"
                            class="reactivate-team-btn"
                            style="color: #4caf50;">
                      <mat-icon>verified</mat-icon>
                    </button>
                    <button mat-icon-button
                            [disabled]="team.hasUsedLink"
                            [class]="team.hasUsedLink ? 'text-muted' : 'text-info'"
                            (click)="copyRegistrationUrl(team.urlRegistration); $event.stopPropagation()"
                            matTooltip="Copiar URL de registro"
                            class="text-secondary">
                      <mat-icon>link</mat-icon>
                    </button>
                  </div>
                </div>
              </div>

              <!-- Layout para Móvil - Solo visible en móvil -->
              <div class="mobile-layout d-none">
                <!-- Avatar -->
                <div class="team-avatar me-3 position-relative">
                  <img [src]="team.logoUrl || 'assets/default-team.png'"
                       [alt]="team.name"
                       class="team-logo"
                       (error)="$event.target.src='assets/default-team.png'"
                       width="40" height="40">
                  <!-- Status Badge sobre la imagen -->
                  <div [class]="getTeamStatusClass(team.status)"
                       [matTooltip]="getTeamStatusText(team.status)"
                       matTooltipPosition="above">
                    <mat-icon class="status-icon">{{ getTeamStatusIcon(team.status) }}</mat-icon>
                  </div>
                </div>

                <!-- Info del equipo y manager -->
                <div class="team-mobile-info flex-grow-1">
                  <h6 class="mb-1 fw-bold team-name-mobile">{{ team.name }}</h6>
                  <div class="manager-mobile" *ngIf="team.manager; else noManagerMobile">
                    <small class="manager-link-mobile"
                           (click)="openManagerInfoModal(team); $event.stopPropagation()"
                           matTooltip="Ver información del manager">
                      Manager: {{ team.manager.managerName }}
                    </small>
                  </div>
                  <ng-template #noManagerMobile>
                    <small class="text-muted">Sin manager</small>
                  </ng-template>
                </div>

                <!-- Menú de 3 puntos para móvil -->
                <div class="mobile-actions-menu">
                  <button mat-icon-button
                          class="mobile-menu-trigger"
                          [matMenuTriggerFor]="teamMobileMenu"
                          (click)="$event.stopPropagation()"
                          matTooltip="Más opciones">
                    <mat-icon>more_vert</mat-icon>
                  </button>

                  <mat-menu #teamMobileMenu="matMenu" class="team-mobile-menu" xPosition="before" yPosition="below">
                    <div class="mobile-menu-content" (click)="$event.stopPropagation()">
                      <!-- Estadísticas -->
                      <div class="mobile-menu-item">
                        <mat-icon>people</mat-icon>
                        <span class="menu-label">Jugadores:</span>
                        <span class="menu-value">{{ team.totalPlayers }}</span>
                      </div>

                      <!-- Switch de registro -->
                      <div class="mobile-menu-item">
                        <mat-icon>settings</mat-icon>
                        <span class="menu-label">Registro:</span>
                        <div class="mobile-toggle-container">
                          <mat-slide-toggle
                            [checked]="team.allowPlayerRegistration || false"
                            (change)="onTogglePlayerRegistration(team, $event)"
                            [disabled]="isUpdatingTeamRegistration(team)"
                            class="mobile-registration-toggle">
                            <span class="toggle-label-mobile">
                              <mat-spinner *ngIf="isUpdatingTeamRegistration(team)" diameter="14" class="inline-spinner"></mat-spinner>
                              {{ (team.allowPlayerRegistration || false) ? 'Habilitado' : 'Deshabilitado' }}
                            </span>
                          </mat-slide-toggle>
                        </div>
                      </div>

                      <div class="mobile-menu-divider"></div>

                      <!-- Acciones principales -->
                      <div class="mobile-menu-item action-item" (click)="createPlayer(team)">
                        <mat-icon class="text-success">person_add</mat-icon>
                        <span class="action-label">Agregar jugador</span>
                      </div>

                      <div class="mobile-menu-item action-item" (click)="editTeam(team)">
                        <mat-icon class="text-primary">edit</mat-icon>
                        <span class="action-label">Editar equipo</span>
                      </div>

                      <div class="mobile-menu-item action-item"
                           *ngIf="!team.hasExcelUploaded"
                           (click)="uploadExcelDocument(team)">
                        <mat-icon class="text-info">upload_file</mat-icon>
                        <span class="action-label">Subir Excel</span>
                      </div>

                      <div class="mobile-menu-item action-item"
                           *ngIf="canDisqualifyTeam(team)"
                           (click)="disqualifyTeam(team)">
                        <mat-icon class="text-warning">gavel</mat-icon>
                        <span class="action-label">Descalificar</span>
                      </div>

                      <div class="mobile-menu-item action-item"
                           *ngIf="canReactivateTeam(team)"
                           (click)="reactivateTeam(team)">
                        <mat-icon style="color: #4caf50;">verified</mat-icon>
                        <span class="action-label">Reactivar</span>
                      </div>

                      <div class="mobile-menu-item action-item"
                           *ngIf="!team.hasUsedLink"
                           (click)="copyRegistrationUrl(team.urlRegistration)">
                        <mat-icon class="text-info">link</mat-icon>
                        <span class="action-label">Copiar enlace</span>
                      </div>

                      <div class="mobile-menu-divider"></div>

                      <div class="mobile-menu-item action-item danger-action" (click)="deleteTeam(team)">
                        <mat-icon class="text-danger">delete</mat-icon>
                        <span class="action-label">Eliminar equipo</span>
                      </div>
                    </div>
                  </mat-menu>
                </div>
              </div>
            </mat-panel-title>
          </mat-expansion-panel-header>

          <!-- Contenido del panel: lista de jugadores -->
          <div class="players-list p-3">
            <div *ngIf="getPlayersForTeam(team).length === 0" class="text-center text-muted py-3">
              <mat-icon>person_off</mat-icon>
              <p class="mb-0">No hay jugadores registrados en este equipo</p>
            </div>

            <div *ngFor="let player of getPlayersForTeam(team); trackBy: trackByPlayerId" class="player-item border-bottom">
              <!-- Layout Desktop - Información completa -->
              <div class="d-none d-md-flex align-items-center py-2 player-desktop-layout">
                <!-- Foto -->
                <div class="player-avatar me-3 flex-shrink-0">
                  <img [src]="player.photoUrl || 'assets/person.jpg'"
                       [alt]="getPlayerFullName(player)"
                       class="player-photo"
                       width="40" height="40"
                       (error)="$event.target.src='assets/person.jpg'">
                </div>

                <!-- Número de camiseta -->
                <div class="player-jersey me-3 flex-shrink-0">
                  <span class="badge bg-secondary">#{{ player.jerseyNumber }}</span>
                </div>

                <!-- Nombre completo e identificación -->
                <div class="player-info flex-grow-1 me-3 text-start">
                  <div class="player-name-container">
                    <strong class="d-block text-start">{{ getPlayerFullName(player) }}</strong>
                    <small class="text-muted d-block text-start">C.I: {{ player.identification }}</small>
                  </div>
                </div>

                <!-- Posición -->
                <div class="player-position me-3 flex-shrink-0 text-start">
                  <div class="d-flex align-items-center justify-content-start">
                    <mat-icon class="me-1 text-muted">sports_soccer</mat-icon>
                    <small class="text-muted">{{ player.position }}</small>
                  </div>
                </div>

                <!-- Acciones del jugador -->
                <div class="player-actions flex-shrink-0">
                  <div class="d-flex align-items-center gap-1">
                    <button mat-icon-button
                            (click)="editPlayer(player, team)"
                            [disabled]="isDeletingPlayer(player)"
                            matTooltip="Editar jugador"
                            class="text-primary">
                      <mat-icon>edit</mat-icon>
                    </button>
                    <button mat-icon-button
                            (click)="deletePlayer(player, team)"
                            [disabled]="isDeletingPlayer(player)"
                            [matTooltip]="isDeletingPlayer(player) ? 'Eliminando jugador...' : 'Eliminar jugador'"
                            class="text-danger">
                      <mat-spinner *ngIf="isDeletingPlayer(player)" diameter="16" class="inline-spinner"></mat-spinner>
                      <mat-icon *ngIf="!isDeletingPlayer(player)">delete</mat-icon>
                    </button>
                  </div>
                </div>
              </div>

              <!-- Layout Móvil - Solo avatar, nombre y cédula -->
              <div class="d-block d-md-none player-mobile-layout">
                <div class="d-flex align-items-center py-2">
                  <!-- Avatar -->
                  <div class="player-avatar me-3 flex-shrink-0">
                    <img [src]="player.photoUrl || 'assets/person.jpg'"
                         [alt]="getPlayerFullName(player)"
                         class="player-photo"
                         width="40" height="40"
                         (error)="$event.target.src='assets/person.jpg'">
                  </div>

                  <!-- Nombre y cédula -->
                  <div class="player-mobile-info flex-grow-1">
                    <strong class="d-block">{{ getPlayerFullName(player) }}</strong>
                    <small class="text-muted d-block">C.I: {{ player.identification }}</small>
                  </div>

                  <!-- Botón de 3 puntos -->
                  <div class="player-mobile-actions">
                    <button mat-icon-button
                            class="player-mobile-menu-trigger"
                            [matMenuTriggerFor]="playerMobileMenu"
                            matTooltip="Más opciones">
                      <mat-icon>more_vert</mat-icon>
                    </button>

                    <mat-menu #playerMobileMenu="matMenu" class="player-mobile-menu" xPosition="before" yPosition="below">
                      <div class="player-mobile-menu-content" (click)="$event.stopPropagation()">
                        <!-- Número de camiseta -->
                        <div class="mobile-menu-item">
                          <mat-icon>tag</mat-icon>
                          <span class="menu-label">Número:</span>
                          <span class="menu-value">#{{ player.jerseyNumber }}</span>
                        </div>

                        <!-- Posición -->
                        <div class="mobile-menu-item">
                          <mat-icon>sports_soccer</mat-icon>
                          <span class="menu-label">Posición:</span>
                          <span class="menu-value">{{ player.position }}</span>
                        </div>

                        <div class="mobile-menu-divider"></div>

                        <!-- Acciones -->
                        <div class="mobile-menu-item action-item" (click)="editPlayer(player, team)">
                          <mat-icon class="text-primary">edit</mat-icon>
                          <span class="action-label">Editar jugador</span>
                        </div>

                        <div class="mobile-menu-item action-item danger-action" 
                             (click)="deletePlayer(player, team)"
                             [class.disabled]="isDeletingPlayer(player)">
                          <mat-spinner *ngIf="isDeletingPlayer(player)" diameter="16" class="inline-spinner me-2"></mat-spinner>
                          <mat-icon *ngIf="!isDeletingPlayer(player)" class="text-danger">delete</mat-icon>
                          <span class="action-label">{{ isDeletingPlayer(player) ? 'Eliminando...' : 'Eliminar jugador' }}</span>
                        </div>
                      </div>
                    </mat-menu>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </mat-expansion-panel>
        </mat-accordion>
      </div>
    </mat-card-content>
  </mat-card>
</div>
