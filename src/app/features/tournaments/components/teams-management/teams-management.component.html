<div class="teams-management-container">
  <mat-card class="teams-management-card">
    <mat-card-header>
      <div class="container-fluid">
        <div class="row align-items-center">
          <div class="col-6">
            <mat-card-title>
              <mat-icon>groups</mat-icon>
              Equipos del Torneo
            </mat-card-title>
            <mat-card-subtitle>
              Administra los equipos participantes en tu torneo
            </mat-card-subtitle>
          </div>
          <div class="col-2 d-flex justify-content-center">
            <button mat-raised-button
                    color="primary"
                    class="download-example-btn"
                    (click)="downloadExampleExcel()"
                    matTooltip="Descargar plantilla de Excel de ejemplo">
              <mat-icon>download</mat-icon>
              Excel Ejemplo
            </button>
          </div>
          <div class="col-4">
            <div class="row justify-content-end">
              <div class="col-auto">
                <mat-form-field appearance="outline" class="search-field">
                  <mat-label>Buscar equipos</mat-label>
                  <input matInput
                         [(ngModel)]="searchTerm"
                         (input)="onSearchChange()"
                         placeholder="Nombre o nombre corto"
                         autocomplete="off">
                  <mat-icon matSuffix>search</mat-icon>
                </mat-form-field>
              </div>
            </div>
          </div>
        </div>
      </div>
    </mat-card-header>

    <mat-card-content>
      <!-- Floating Action Button for Teams -->
      <button mat-fab
              class="fab-fixed add-team-btn"
              (click)="createTeam()"
              matTooltip="Crear nuevo equipo">
        <mat-icon>add</mat-icon>
      </button>

      <!-- No Teams Message -->
      <div class="no-teams" *ngIf="filteredTeams.length === 0 && searchTerm === ''">
        <mat-icon class="no-teams-icon">groups</mat-icon>
        <h3>No hay equipos registrados</h3>
        <p>Comienza agregando el primer equipo a tu torneo</p>
      </div>

      <!-- No Search Results -->
      <div class="no-teams" *ngIf="filteredTeams.length === 0 && searchTerm !== ''">
        <mat-icon class="no-teams-icon">search_off</mat-icon>
        <h3>No se encontraron equipos</h3>
        <p>No hay equipos que coincidan con "{{ searchTerm }}"</p>
      </div>

      <!-- Teams List con Paneles de Expansión -->
      <div *ngIf="filteredTeams.length > 0" class="teams-list">
        <mat-accordion [multi]="false">
        <mat-expansion-panel *ngFor="let team of filteredTeams; trackBy: trackByTeamId" class="team-panel">
          <mat-expansion-panel-header>
            <mat-panel-title class="w-100">
              <div class="row align-items-center w-100 g-3">
                <!-- Avatar e info principal -->
                <div class="col-md-4 d-flex align-items-center">
                  <div class="team-avatar me-3 position-relative">
                    <img [src]="team.logoUrl || 'assets/logo.png'"
                         [alt]="team.name"
                         class="team-logo"
                         (error)="$event.target.src='assets/logo.png'"
                         width="50" height="50">
                    <!-- Status Badge sobre la imagen -->
                    <div [class]="getTeamStatusClass(team.status)"
                         [matTooltip]="getTeamStatusText(team.status)"
                         matTooltipPosition="above">
                      <mat-icon class="status-icon">{{ getTeamStatusIcon(team.status) }}</mat-icon>
                    </div>
                  </div>
                  <div class="team-info">
                    <h5 class="mb-1 fw-bold">{{ team.name }}</h5>
                    <small class="text-muted">{{ team.shortName }}</small>
                  </div>
                </div>

                <!-- Estadísticas -->
                <div class="col-md-3 d-flex align-items-center">
                  <div class="d-flex align-items-center me-3">
                    <mat-icon class="text-primary me-1">people</mat-icon>
                    <span class="badge bg-primary rounded-pill">{{ team.totalPlayers }}</span>
                  </div>
                  <div class="manager-info flex-grow-1">
                    <small class="text-muted d-block">{{team.manager ? 'Manager: ' + team.manager.managerName : 'Sin manager asignado'}}</small>
                    <small class="text-muted d-block" *ngIf="team.manager">Contacto: {{ team.manager.phoneNumber }}</small>
                  </div>
                </div>

                <!-- Switch -->
                <div class="col-md-2 d-flex justify-content-left">
                  <mat-slide-toggle
                    [checked]="team.allowPlayerRegistration || false"
                    (change)="onTogglePlayerRegistration(team, $event)"
                    (click)="$event.stopPropagation()"
                    [disabled]="isUpdatingTeamRegistration(team)"
                    [matTooltip]="isUpdatingTeamRegistration(team) ? 'Actualizando...' : 'Permitir registro de jugadores'"
                    class="registration-toggle">
                    <span class="toggle-label">
                      <mat-spinner *ngIf="isUpdatingTeamRegistration(team)" diameter="16" class="inline-spinner"></mat-spinner>
                      {{ (team.allowPlayerRegistration || false) ? 'Habilitado' : 'Deshabilitado' }}
                    </span>
                  </mat-slide-toggle>
                </div>

                <!-- Acciones -->
                <div class="col-md-3 d-flex justify-content-end">
                  <div class="btn-group" role="group">
                    <button mat-icon-button
                            (click)="createPlayer(team); $event.stopPropagation()"
                            matTooltip="Agregar jugador"
                            class="text-success">
                      <mat-icon>person_add</mat-icon>
                    </button>
                    <button mat-icon-button
                            (click)="editTeam(team); $event.stopPropagation()"
                            matTooltip="Editar equipo"
                            class="text-primary">
                      <mat-icon>edit</mat-icon>
                    </button>
                    <button mat-icon-button
                            (click)="deleteTeam(team); $event.stopPropagation()"
                            matTooltip="Eliminar equipo"
                            class="text-danger">
                      <mat-icon>delete</mat-icon>
                    </button>
                    <button mat-icon-button
                            [matTooltip]="team.hasExcelUploaded ? 'Excel ya subido' : 'Subir excel de registro de jugadores'"
                            [class]="team.hasExcelUploaded ? 'text-muted' : 'text-info'"
                            [disabled]="team.hasExcelUploaded"
                            (click)="uploadExcelDocument(team); $event.stopPropagation()">
                      <mat-icon>upload_file</mat-icon>
                    </button>
                    <!-- Botón para descalificar (solo si está activo) -->
                    <button mat-icon-button
                            *ngIf="canDisqualifyTeam(team)"
                            (click)="disqualifyTeam(team); $event.stopPropagation()"
                            matTooltip="Descalificar equipo"
                            class="text-warning">
                      <mat-icon>gavel</mat-icon>
                    </button>

                    <!-- Botón para reactivar (solo si está descalificado) -->
                    <button mat-icon-button
                            *ngIf="canReactivateTeam(team)"
                            (click)="reactivateTeam(team); $event.stopPropagation()"
                            matTooltip="Volver a validar equipo"
                            class="reactivate-team-btn"
                            style="color: #4caf50;">
                      <mat-icon>verified</mat-icon>
                    </button>
                    <button mat-icon-button
                            *ngIf="!team.hasUsedLink"
                            (click)="copyRegistrationUrl(team.urlRegistration); $event.stopPropagation()"
                            matTooltip="Copiar URL de registro"
                            class="text-secondary">
                      <mat-icon>link</mat-icon>
                    </button>
                  </div>
                </div>
              </div>
            </mat-panel-title>
          </mat-expansion-panel-header>

          <!-- Contenido del panel: lista de jugadores -->
          <div class="players-list p-3">
            <div *ngIf="getPlayersForTeam(team).length === 0" class="text-center text-muted py-3">
              <mat-icon>person_off</mat-icon>
              <p class="mb-0">No hay jugadores registrados en este equipo</p>
            </div>

            <div *ngFor="let player of getPlayersForTeam(team); trackBy: trackByPlayerId" class="player-item d-flex align-items-center py-2 border-bottom">
              <!-- Foto -->
              <div class="player-avatar me-3 flex-shrink-0">
                <img [src]="player.photoUrl || 'assets/logo.png'"
                     [alt]="getPlayerFullName(player)"
                     class="player-photo"
                     width="40" height="40"
                     (error)="$event.target.src='assets/logo.png'">
              </div>

              <!-- Número de camiseta -->
              <div class="player-jersey me-3 flex-shrink-0">
                <span class="badge bg-secondary">#{{ player.jerseyNumber }}</span>
              </div>

              <!-- Nombre completo e identificación -->
              <div class="player-info flex-grow-1 me-3 text-start">
                <div class="player-name-container">
                  <strong class="d-block text-start">{{ getPlayerFullName(player) }}</strong>
                  <small class="text-muted d-block text-start">C.I: {{ player.identification }}</small>
                </div>
              </div>

              <!-- Posición -->
              <div class="player-position me-3 flex-shrink-0 text-start">
                <div class="d-flex align-items-center justify-content-start">
                  <mat-icon class="me-1 text-muted">sports_soccer</mat-icon>
                  <small class="text-muted">{{ player.position }}</small>
                </div>
              </div>

              <!-- Acciones del jugador -->
              <div class="player-actions flex-shrink-0">
                <div class="d-flex align-items-center gap-1">
                  <button mat-icon-button
                          (click)="editPlayer(player, team)"
                          matTooltip="Editar jugador"
                          class="text-primary">
                    <mat-icon>edit</mat-icon>
                  </button>
                  <button mat-icon-button
                          (click)="deletePlayer(player, team)"
                          matTooltip="Eliminar jugador"
                          class="text-danger">
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </mat-expansion-panel>
        </mat-accordion>
      </div>
    </mat-card-content>
  </mat-card>
</div>
